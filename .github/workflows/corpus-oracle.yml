name: Corpus Oracle

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: corpus-${{ github.ref }}
  cancel-in-progress: true

on:
  # Weekly Sunday night
  schedule:
    - cron: "0 4 * * 0"
  # Manual trigger
  workflow_dispatch:
    inputs:
      repo_filter:
        description: "Run only this repo ID (e.g. 'multi_json__multi_json__c5fa9fc'), or 'all'"
        default: "all"
  # On cop implementation changes
  pull_request:
    paths:
      - "src/cop/**"
      - "src/config/**"
      - "src/resources/tiers.json"
      - "bench/corpus/**"

env:
  CARGO_TERM_COLOR: always

jobs:
  # â”€â”€ Build turbocop release binary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-turbocop:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: turbocop-binary
          path: target/release/turbocop
          retention-days: 1

  # â”€â”€ Compute matrix (1 repo per job) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  compute-matrix:
    runs-on: ubuntu-24.04
    timeout-minutes: 2
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate matrix
        id: matrix
        run: |
          python3 << 'PYEOF'
          import json, os, sys

          repos = []
          with open('bench/corpus/manifest.jsonl') as f:
              for line in f:
                  line = line.strip()
                  if line:
                      repos.append(json.loads(line))

          repo_filter = os.environ.get('REPO_FILTER', 'all')
          if repo_filter != 'all':
              repos = [r for r in repos if r['id'] == repo_filter]
              if not repos:
                  print(f"ERROR: no repo matching '{repo_filter}' in manifest", file=sys.stderr)
                  sys.exit(1)

          entries = [{'id': r['id'], 'repo_url': r['repo_url'], 'sha': r['sha']} for r in repos]
          print(f'{len(entries)} repos in matrix', file=sys.stderr)
          matrix = {'include': entries}
          with open(os.environ['GITHUB_OUTPUT'], 'a') as out:
              out.write(f'matrix={json.dumps(matrix)}\n')
          PYEOF
        env:
          REPO_FILTER: ${{ github.event.inputs.repo_filter || 'all' }}

  # â”€â”€ Run oracle on each repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  oracle-repo:
    needs: [build-turbocop, compute-matrix]
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.compute-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Download turbocop binary
        uses: actions/download-artifact@v4
        with:
          name: turbocop-binary
          path: bin/

      - name: Make binary executable
        run: chmod +x bin/turbocop

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"

      - name: Cache baseline bundle
        uses: actions/cache@v4
        with:
          path: bench/corpus/vendor/bundle
          key: corpus-bundle-${{ hashFiles('bench/corpus/Gemfile') }}

      - name: Install baseline gems
        run: |
          cd bench/corpus
          bundle config set --local path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Clone repo
        run: |
          mkdir -p repos
          REPO_ID="${{ matrix.id }}"
          REPO_URL="${{ matrix.repo_url }}"
          REPO_SHA="${{ matrix.sha }}"
          DEST="repos/${REPO_ID}"
          echo "Cloning ${REPO_ID} at ${REPO_SHA:0:7}..."

          git clone --depth 50 --no-recurse-submodules --single-branch "$REPO_URL" "$DEST"

          if ! git -C "$DEST" checkout "$REPO_SHA" 2>/dev/null; then
            echo "Shallow clone missing SHA, fetching deeper..."
            git -C "$DEST" fetch --depth 200
            git -C "$DEST" checkout "$REPO_SHA" || echo "WARNING: checkout failed, using HEAD"
          fi

      - name: Export turbocop cop list
        run: bin/turbocop --list-cops > turbocop-cops.txt

      - name: Run turbocop
        run: |
          REPO_ID="${{ matrix.id }}"
          mkdir -p results/turbocop
          echo "=== turbocop: ${REPO_ID} ==="
          BUNDLE_GEMFILE=$PWD/bench/corpus/Gemfile \
          BUNDLE_PATH=$PWD/bench/corpus/vendor/bundle \
          bin/turbocop \
            --preview \
            --format json \
            --no-cache \
            --config bench/corpus/baseline_rubocop.yml \
            "repos/${REPO_ID}" \
            > "results/turbocop/${REPO_ID}.json" 2>results/turbocop/${REPO_ID}.err || true

      - name: Run RuboCop
        run: |
          REPO_ID="${{ matrix.id }}"
          mkdir -p results/rubocop
          echo "=== rubocop: ${REPO_ID} ==="
          BUNDLE_GEMFILE=$PWD/bench/corpus/Gemfile \
          BUNDLE_PATH=$PWD/bench/corpus/vendor/bundle \
          bundle exec rubocop \
            --config bench/corpus/baseline_rubocop.yml \
            --format json \
            --force-exclusion \
            --cache false \
            "repos/${REPO_ID}" \
            > "results/rubocop/${REPO_ID}.json" 2>results/rubocop/${REPO_ID}.err || true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: corpus-results-${{ matrix.id }}
          path: |
            results/
            turbocop-cops.txt
          retention-days: 7

  # â”€â”€ Collect and diff all results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  collect-results:
    needs: [oracle-repo]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: corpus-results-*
          path: all-results/
          merge-multiple: true

      - name: Diff and generate report
        run: |
          # Cop list is uploaded alongside results from any repo job
          COP_LIST=$(find all-results -name turbocop-cops.txt -print -quit)
          python3 bench/corpus/diff_results.py \
            --turbocop-dir all-results/results/turbocop \
            --rubocop-dir all-results/results/rubocop \
            --manifest bench/corpus/manifest.jsonl \
            --output-json corpus-results.json \
            --output-md corpus-results.md \
            ${COP_LIST:+--cop-list "$COP_LIST"}

      - name: Generate tiers.json
        run: |
          python3 bench/corpus/gen_tiers.py \
            --input corpus-results.json \
            --output tiers.json

      - name: Print summary
        run: |
          cat corpus-results.md
          cat corpus-results.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: corpus-report
          path: |
            corpus-results.json
            corpus-results.md
            tiers.json
          retention-days: 30

      - name: Open PR if tiers changed
        if: hashFiles('tiers.json') != hashFiles('src/resources/tiers.json')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="corpus-oracle/update-tiers-$(date +%s)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B "$BRANCH"
          cp tiers.json src/resources/tiers.json
          git add src/resources/tiers.json
          git commit -m "Update tiers.json from corpus oracle results"
          git push origin "$BRANCH"

          gh pr create \
              --title "Update tiers.json from corpus oracle" \
              --body "$(cat <<'EOF'
          ## Summary

          Auto-generated from corpus oracle run. Cops with any false positives
          across the corpus are demoted to preview tier.

          - **Stable**: cops with 0 FP across all corpus repos
          - **Preview**: cops with >= 1 FP

          CI will validate the new tiers.json compiles and passes tests.

          ðŸ¤– Generated by corpus oracle workflow
          EOF
          )" \
              --head "$BRANCH" \
              --base main
