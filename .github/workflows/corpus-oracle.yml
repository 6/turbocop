name: Corpus Oracle

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: corpus-${{ github.ref }}
  cancel-in-progress: true

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      repo_filter:
        description: "Run only this repo ID (e.g. 'multi_json__multi_json__c5fa9fc'), or 'all'"
        default: "all"
  # On cop implementation changes
  pull_request:
    paths:
      - "src/cop/**"
      - "src/config/**"
      - "src/resources/tiers.json"
      - "bench/corpus/**"

env:
  CARGO_TERM_COLOR: always

jobs:
  # â”€â”€ Build turbocop release binary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-turbocop:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: turbocop-binary
          path: target/release/turbocop
          retention-days: 1

  # â”€â”€ Compute matrix (batched, N repos per job) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  compute-matrix:
    runs-on: ubuntu-24.04
    timeout-minutes: 2
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate matrix
        id: matrix
        run: |
          python3 << 'PYEOF'
          import json, os, sys

          BATCH_SIZE = 4

          repos = []
          with open('bench/corpus/manifest.jsonl') as f:
              for line in f:
                  line = line.strip()
                  if line:
                      repos.append(json.loads(line))

          repo_filter = os.environ.get('REPO_FILTER', 'all')
          if repo_filter != 'all':
              repos = [r for r in repos if r['id'] == repo_filter]
              if not repos:
                  print(f"ERROR: no repo matching '{repo_filter}' in manifest", file=sys.stderr)
                  sys.exit(1)

          # Build batches of repos
          batches = []
          for i in range(0, len(repos), BATCH_SIZE):
              chunk = repos[i:i+BATCH_SIZE]
              batches.append({
                  'batch_id': str(i // BATCH_SIZE),
                  'repos_json': json.dumps([{'id': r['id'], 'repo_url': r['repo_url'], 'sha': r['sha']} for r in chunk]),
              })

          print(f'{len(repos)} repos in {len(batches)} batches (batch_size={BATCH_SIZE})', file=sys.stderr)
          matrix = {'include': batches}
          with open(os.environ['GITHUB_OUTPUT'], 'a') as out:
              out.write(f'matrix={json.dumps(matrix)}\n')
          PYEOF
        env:
          REPO_FILTER: ${{ github.event.inputs.repo_filter || 'all' }}

  # â”€â”€ Run oracle on each batch of repos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  oracle-repo:
    needs: [build-turbocop, compute-matrix]
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.compute-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Download turbocop binary
        uses: actions/download-artifact@v4
        with:
          name: turbocop-binary
          path: bin/

      - name: Make binary executable
        run: chmod +x bin/turbocop

      # Ruby version read from mise.toml
      - uses: ruby/setup-ruby@v1

      - name: Cache baseline bundle
        uses: actions/cache@v4
        with:
          path: bench/corpus/vendor/bundle
          key: corpus-bundle-${{ hashFiles('bench/corpus/Gemfile') }}

      - name: Install baseline gems
        run: |
          cd bench/corpus
          bundle config set --local path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Export turbocop cop list
        run: bin/turbocop --list-cops > turbocop-cops.txt

      - name: Run batch
        env:
          REPOS_JSON: ${{ matrix.repos_json }}
        run: |
          mkdir -p results/turbocop results/rubocop

          echo "$REPOS_JSON" | jq -c '.[]' | while IFS= read -r row; do
            REPO_ID=$(echo "$row" | jq -r '.id')
            REPO_URL=$(echo "$row" | jq -r '.repo_url')
            REPO_SHA=$(echo "$row" | jq -r '.sha')

            echo "::group::${REPO_ID}"

            # Clone
            DEST="repos/${REPO_ID}"
            echo "Cloning ${REPO_ID} at ${REPO_SHA:0:7}..."
            git clone --depth 50 --no-recurse-submodules --single-branch "$REPO_URL" "$DEST" || { echo "Clone failed for ${REPO_ID}"; echo "::endgroup::"; continue; }

            if ! git -C "$DEST" checkout "$REPO_SHA" 2>/dev/null; then
              echo "Shallow clone missing SHA, fetching deeper..."
              git -C "$DEST" fetch --depth 200
              git -C "$DEST" checkout "$REPO_SHA" || echo "WARNING: checkout failed, using HEAD"
            fi

            # turbocop
            echo "=== turbocop: ${REPO_ID} ==="
            BUNDLE_GEMFILE=$PWD/bench/corpus/Gemfile \
            BUNDLE_PATH=$PWD/bench/corpus/vendor/bundle \
            bin/turbocop \
              --preview \
              --format json \
              --no-cache \
              --config bench/corpus/baseline_rubocop.yml \
              "$DEST" \
              > "results/turbocop/${REPO_ID}.json" 2>"results/turbocop/${REPO_ID}.err" || true

            # rubocop
            echo "=== rubocop: ${REPO_ID} ==="
            BUNDLE_GEMFILE=$PWD/bench/corpus/Gemfile \
            BUNDLE_PATH=$PWD/bench/corpus/vendor/bundle \
            bundle exec rubocop \
              --config bench/corpus/baseline_rubocop.yml \
              --format json \
              --force-exclusion \
              --cache false \
              "$DEST" \
              > "results/rubocop/${REPO_ID}.json" 2>"results/rubocop/${REPO_ID}.err" || true

            # Free disk space between repos
            rm -rf "$DEST"

            echo "::endgroup::"
          done

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: corpus-results-${{ matrix.batch_id }}
          path: |
            results/
            turbocop-cops.txt
          retention-days: 7

  # â”€â”€ Collect and diff all results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  collect-results:
    needs: [oracle-repo]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: corpus-results-*
          path: all-results/
          merge-multiple: true

      - name: Diff and generate report
        run: |
          # Cop list is uploaded alongside results from any repo job
          COP_LIST=$(find all-results -name turbocop-cops.txt -print -quit)
          python3 bench/corpus/diff_results.py \
            --turbocop-dir all-results/results/turbocop \
            --rubocop-dir all-results/results/rubocop \
            --manifest bench/corpus/manifest.jsonl \
            --output-json corpus-results.json \
            --output-md corpus-results.md \
            ${COP_LIST:+--cop-list "$COP_LIST"}

      - name: Generate tiers.json
        run: |
          python3 bench/corpus/gen_tiers.py \
            --input corpus-results.json \
            --output tiers.json

      - name: Update README conformance
        run: |
          python3 bench/corpus/update_readme.py \
            --input corpus-results.json \
            --manifest bench/corpus/manifest.jsonl \
            --readme README.md

      - name: Print summary
        run: |
          cat corpus-results.md
          cat corpus-results.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: corpus-report
          path: |
            corpus-results.json
            corpus-results.md
            tiers.json
          retention-days: 30

      - name: Update corpus report
        run: cp corpus-results.md docs/corpus.md

      - name: Open PR if tiers, README, or corpus report changed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHANGED=false

          if ! diff -q tiers.json src/resources/tiers.json >/dev/null 2>&1; then
            CHANGED=true
          fi
          if ! git diff --quiet README.md; then
            CHANGED=true
          fi
          if ! git diff --quiet docs/corpus.md; then
            CHANGED=true
          fi

          if [ "$CHANGED" = false ]; then
            echo "No changes to commit"
            exit 0
          fi

          BRANCH="corpus-oracle/update-$(date +%s)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B "$BRANCH"

          if ! diff -q tiers.json src/resources/tiers.json >/dev/null 2>&1; then
            cp tiers.json src/resources/tiers.json
            git add src/resources/tiers.json
          fi
          git add -f README.md docs/corpus.md

          git commit -m "Update tiers.json, README, and corpus report from corpus oracle results"
          git push origin "$BRANCH"

          gh pr create \
              --title "Update tiers.json and README from corpus oracle" \
              --body "$(cat <<'EOF'
          ## Summary

          Auto-generated from corpus oracle run.

          **Tiers**: Cops with any false positives across the corpus are demoted
          to preview tier. Stable = 0 FP, Preview = >= 1 FP.

          **README**: Conformance percentages and top-15 repo table updated
          from latest corpus results.

          **Corpus report**: Full 500-repo conformance breakdown at docs/corpus.md.

          CI will validate the changes compile and pass tests.

          ðŸ¤– Generated by corpus oracle workflow
          EOF
          )" \
              --head "$BRANCH" \
              --base main
